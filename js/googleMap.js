var mapMarkers = {
	"obstructions": [
		{"name": "Submerged Tree", "center": {lat: 38.1025, lng: -121.5625}}, 
		{"name": "Embedded Log", "center": {lat: 38.1200, lng: -121.5855}}
	],
	"anchorages": [
		{"name": "The Meadows", "center": {lat: 38.2509717, lng: -121.497613}},
		{"name": "Mandaville Tip", "center": {lat: 38.0618274, lng: -121.5345715}},
		{"name": "The Bedrooms in Potato Slough", "center": {lat: 38.0841627, lng: -121.538574}}
	],
	"restaurants": [
		{"name": "Korth's Pirates' Lair", "center": {lat: 38.0977543, lng: -121.5680157}, "fb": "https://www.facebook.com/Korths-Pirates-Lair-Marina-348297131692/timeline/"},
		{"name": "Lighthouse", "center": {lat: 38.1057531, lng: -121.5707022}, "fb": "https://www.facebook.com/Lighthouse-Marina-Restaurant-and-Resort-151574161575567/timeline/"},
		{"name": "Moore's Riverboat", "center": {lat: 38.1007412, lng: -121.5658718}, "fb": "https://www.facebook.com/pages/Moores-Riverboat-Isleton/128136840571906?fref=ts"},
		{"name": "Rosa's", "center": {lat: 38.1101495, lng: -121.4983044}, "fb": "https://www.facebook.com/Rosasattowerpark"},
		{"name": "Giusti's Place", "center": {lat: 38.2242578, lng: -121.5071795}, "fb": "https://www.facebook.com/Giustis-341683185695/timeline/"},
		{"name": "Windmill Cove", "center": {lat: 37.9910241, lng: -121.4074522}, "fb": "https://www.facebook.com/Windmill-Cove-Bar-and-Grill-158184030912668/timeline/"},
		{"name": "The Point", "center": {lat: 38.1487831, lng: -121.6909701}, "fb": "https://www.facebook.com/ThePointRestaurantRioVista"},
		{"name": "Boardwalk Grill", "center": {lat: 37.9056747, lng: -121.5869824}, "fb": "https://www.facebook.com/Boardwalk-Grill-285018528287/timeline/"},
		{"name": "Wimpy's", "center": {lat: 38.2264718, lng: -121.490745}, "fb": "https://www.facebook.com/Wimpys-Marina-405286399555382/timeline/"},
		{"name": "Orwood", "center": {lat: 37.9388633, lng: -121.6123867}, "fb": "https://www.facebook.com/orwoodresort"},
		{"name": "Rusty Porthole", "center": {lat: 38.0347238, lng: -121.6230485}, "fb": "https://www.facebook.com/Rusty-Porthole-217097898307326/timeline/"}
	],
	"bars": [
		{"name": "Windmill Cove", "center": {lat: 37.9910241, lng: -121.4074522}, "fb": "https://www.facebook.com/Windmill-Cove-Bar-and-Grill-158184030912668/timeline/"},
		{"name": "Lost Isle", "center": {lat: 37.9989336, lng: -121.4498872}, "fb": "https://www.facebook.com/groups/327403865799/"},
		{"name": "Sugar Barge", "center": {lat: 38.0280595, lng: -121.6116769}, "fb": "https://www.facebook.com/sugar.barge?fref=ts"},
		{"name": "Spindrift", "center": {lat: 38.1077053, lng: -121.5981793}, "fb": "http://www.thespindrift.com/"}
	],
	"repairs": [
		{"name": "Delta Boat Works", "center": {lat: 38.0997402, lng: -121.5669706}, "fb": "http://deltaboatworks.com/"},
		{"name": "Perry's", "center": {lat: 38.1255365, lng: -121.5820935}, "fb": "http://www.perrysboatharbor.com/"},
		{"name": "Tower Park Marina Resort", "center": {lat: 38.1101495, lng: -121.4983044}, "fb": "https://www.facebook.com/pages/Tower-Park-Marina-And-Resort/150871971609324"}
	],
	"gas": [
		{"name": "Willow Berm", "center": {lat: 38.1038469, lng: -121.5677196}, "fb": "https://www.facebook.com/willowberm?fref=ts"},
		{"name": "Paradise Point", "center": {lat: 38.0464052, lng: -121.4182412}, "fb": "https://www.facebook.com/ParadisePointMarina"},
		{"name": "Tower Park Marina Resort", "center": {lat: 38.1101495, lng: -121.4983044}, "fb": "https://www.facebook.com/pages/Tower-Park-Marina-And-Resort/150871971609324"},
		{"name": "Windmill Cove", "center": {lat: 37.9910241, lng: -121.4074522}, "fb": "https://www.facebook.com/Windmill-Cove-Bar-and-Grill-158184030912668/timeline/"},
		{"name": "B & W", "center": {lat: 38.1285623, lng: -121.5801002}, "fb": "https://www.facebook.com/B-W-Resort-Marina-118918581453710/timeline/"}
	],
	"berthing": [
		{"name": "Discovery Bay", "center": {lat: 37.9056747, lng: -121.5869824}, "fb": "https://www.facebook.com/Discovery-Bay-Yacht-Harbor-134771066597263/timeline/"},
		{"name": "Whiskey Slough", "center": {lat: 37.9357669, lng: -121.4326344}, "fb": "https://www.facebook.com/Whiskey-Slough-Marina-Indoor-Boat-Storage-Bar-and-Grill-149733071729373/timeline/"},
		{"name": "Tower Park Marina Resort", "center": {lat: 38.1101495, lng: -121.4983044}, "fb": "https://www.facebook.com/pages/Tower-Park-Marina-And-Resort/150871971609324"},
		{"name": "Willow Berm", "center": {lat: 38.1038469, lng: -121.5677196}, "fb": "https://www.facebook.com/willowberm?fref=ts"},
		{"name": "Paradise Point", "center": {lat: 38.0464052, lng: -121.4182412}, "fb": "https://www.facebook.com/ParadisePointMarina"},
		{"name": "B & W", "center": {lat: 38.1285623, lng: -121.5801002}, "fb": "https://www.facebook.com/B-W-Resort-Marina-118918581453710/timeline/"},
		{"name": "Perry's", "center": {lat: 38.1255365, lng: -121.5820935}, "fb": "http://www.perrysboatharbor.com/"},
		{"name": "Spindrift", "center": {lat: 38.1077053, lng: -121.5981793}, "fb": "http://www.spindriftmarina.com/"},
		{"name": "Owl Harbor", "center": {lat: 38.1162493, lng: -121.6257876}, "fb": "https://www.facebook.com/Owl-Harbor-Marina-117030248315538/timeline/"}
	],
	"rentals": [
		{"name": "Tower Park Marina Resort", "center": {lat: 38.1101495, lng: -121.4983044}, "fb": "https://www.facebook.com/pages/Tower-Park-Marina-And-Resort/150871971609324"},
		{"name": "Lighthouse", "center": {lat: 38.1057531, lng: -121.5707022}, "fb": "https://www.facebook.com/Lighthouse-Marina-Restaurant-and-Resort-151574161575567/timeline/"},
		{"name": "Paradise Point", "center": {lat: 38.0464052, lng: -121.4182412}, "fb": "https://www.facebook.com/ParadisePointMarina"}
	],
	"lodging": [
		{"name": "Stockton Delta KOA", "center": {lat: 38.1101495, lng: -121.4983044}, "fb": "https://www.facebook.com/StocktonKOA"},
		{"name": "B & W", "center": {lat: 38.1285623, lng: -121.5801002}, "fb": "https://www.facebook.com/B-W-Resort-Marina-118918581453710/timeline/"},
		{"name": "Whiskey Slough", "center": {lat: 37.9357669, lng: -121.4326344}, "fb": "https://www.facebook.com/Whiskey-Slough-Marina-Indoor-Boat-Storage-Bar-and-Grill-149733071729373/timeline/"}
	],
	"launches": [
		{"name": "Orwood", "center": {lat: 37.9388633, lng: -121.6123867}, "fb": "https://www.facebook.com/orwoodresort"},
		{"name": "Whiskey Slough", "center": {lat: 37.9357669, lng: -121.4326344}, "fb": "https://www.facebook.com/Whiskey-Slough-Marina-Indoor-Boat-Storage-Bar-and-Grill-149733071729373/timeline/"},
		{"name": "Paradise Point", "center": {lat: 38.0464052,lng:  -121.4182412}, "fb": "https://www.facebook.com/Discovery-Bay-Yacht-Harbor-134771066597263/timeline/"},
		{"name": "B & W", "center": {lat: 38.1285623, lng: -121.5801002}, "fb": "https://www.facebook.com/B-W-Resort-Marina-118918581453710/timeline/"},
		{"name": "Discovery Bay", "center": {lat: 37.9056747, lng: -121.5869824}, "fb": "https://www.facebook.com/Discovery-Bay-Yacht-Harbor-134771066597263/timeline/"}
	],
	"stores": [
		{"name": "B & W", "center": {lat: 38.1285623, lng: -121.5801002}, "fb": "https://www.facebook.com/B-W-Resort-Marina-118918581453710/timeline/"},
		{"name": "Paradise Point", "center": {lat: 38.0464052, lng: -121.4182412}, "fb": "https://www.facebook.com/Discovery-Bay-Yacht-Harbor-134771066597263/timeline/"},
		{"name": "Tower Park Marina Resort", "center": {lat: 38.1101495, lng: -121.4983044}, "fb": "https://www.facebook.com/pages/Tower-Park-Marina-And-Resort/150871971609324"}
	]
};


var noaaData = {

	"urls": [
	windURL = "http://tidesandcurrents.noaa.gov/api/datagetter?date=latest"
		+"&station=9415144&product=wind&units=english&time_zone=gmt&application=weather&format=json",
	waterURL = "http://tidesandcurrents.noaa.gov/api/datagetter?date=latest"
		+"&station=9415144&product=water_temperature&units=english&time_zone=gmt&application=weather&format=json",
	airURL = "http://tidesandcurrents.noaa.gov/api/datagetter?date=latest"
		+"&station=9415144&product=air_temperature&units=english&time_zone=gmt&application=weather&format=json"
	],

	"labels": ["Wind Speed: ", "Water Temp: ", "Air Temp: "],

	"attrs": ["s", "v", "v"],

	"suffixes": ["knots", "degrees", "degrees"],
};


var viewModel = {

	//initialize page with menu bar, map and underwater obstruction map markers 
	init: function() {
		var menuBar = document.getElementById('menuBar');
		for (var i = 0; i < viewModel.searchCategories.length; i++) {
			var iconButton = document.createElement('BUTTON');
			iconButton.innerHTML = viewModel.searchCategories[i];
			iconButton.setAttribute("data-bind", "click: categoryClick");
			menuBar.appendChild(iconButton);
		}
		viewModel.noaaRequest();
	},

	statWind: ko.observable("Wind Speed: not available"),
	statWater: ko.observable("Water Temperature: not available"),
	statAir: ko.observable("Air Temperature: not available"),


	noaaRequest: function(data) {
		var noaaFunctions = [viewModel.statWind, viewModel.statWater, viewModel.statAir];

		$.each(noaaData.urls, function (i) {
			//format url for Yahoo proxy
			var yql = 'http://query.yahooapis.com/v1/public/yql?'
	        	+ 'q=' + encodeURIComponent('select * from json where url=@url')
	        	+ '&url=' + encodeURIComponent(noaaData.urls[i])
	        	+ '&format=json&callback=?';

	        //parse data from each URL and push it to HTML through knockout.js
			$.getJSON(yql,
			  function (data) {
			  	var noaaLabel = noaaData.labels[i];
			  	var noaaSuffix = noaaData.suffixes[i];
			  	var noaaAttr = noaaData.attrs[i];
			  	var noaaValue = data.query.results.json.data[noaaAttr];
			  	var noaaFunction = noaaFunctions[i];
			  	noaaFunction(noaaLabel + " " + noaaValue + " " + noaaSuffix);
			});
		})
    },

	searchCategories: Object.keys(mapMarkers),


	userLocation: function(map) {
		var initialLocation = new google.maps.LatLng(38.103, -121.572);
		// Try W3C Geolocation (Preferred)
		if(navigator.geolocation) {
			browserSupportFlag = true;
			navigator.geolocation.getCurrentPosition(function(position) {
		  		initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
		  		map.setCenter(initialLocation);
			}, function() {
		  		handleNoGeolocation(browserSupportFlag);
			});
		}
		// Browser doesn't support Geolocation
		else {
			browserSupportFlag = false;
			handleNoGeolocation(browserSupportFlag);
		}

		function handleNoGeolocation(errorFlag) {
			if (errorFlag == true) {
				  //alert("Geolocation service failed.");
				} else {
				  //alert("Your browser doesn't support geolocation.");
				}
				map.setCenter(initialLocation);
			}
		},

	initMap: function() {
		//draw map
		var mapDiv = document.getElementById('map');
		var mapOptions = {
		    center: {lat: 38.103, lng: -121.572}, 
		    zoom: 12,
		    mapTypeId: google.maps.MapTypeId.HYBRID,
			};
		var map = new google.maps.Map(mapDiv, mapOptions);

		// check for user location to set map
		// TODO: use this OR the preset if user out of range
		// viewModel.userLocation(map);

		// draw the obstruction markers on the map
		for (var i = 0; i < mapMarkers.obstructions.length; i++) {
			new google.maps.Circle({
				strokeColor: '#FF0000',
				strokeOpacity: 0.8,
				strokeWeight: 2,
				fillColor: '#FF0000',
				fillOpacity: 0.35,
				map: map,
				center: mapMarkers.obstructions[i].center,
				radius: 30,
				draggable:true,
			})
		}
		this.map = map;
	},

	sideBarArray: ko.observableArray(),

	markers: [],

	//set markers and bounds based on json information
	addMarkers: function() {
		var loopLength = mapMarkers[this.category].length;
		var bounds = new google.maps.LatLngBounds();
		for (i = 0; i < loopLength; i++) {
			var lat = mapMarkers[this.category][i].center.lat;
			var lng =  mapMarkers[this.category][i].center.lng;
			var location = mapMarkers[this.category][i]['center'];
			
			viewModel.markers.push(new google.maps.Marker({
				position: location,
				map: this.map,
				animation: google.maps.Animation.DROP,
				id: mapMarkers[this.category][i].name,
				icon: 'http://maps.google.com/mapfiles/ms/icons/red.png',
			}));
			viewModel.markers[i].addListener('click', viewModel.highlightToggle);
	    	bounds.extend(new google.maps.LatLng(lat, lng));
		}
		this.map.fitBounds(bounds);
	},


	//populates names in side bar
	addSideBarInfo: function(){
		for (marker in mapMarkers[this.category]){
			this.sideBarArray.push(mapMarkers[this.category][marker]['name']);
			this.sideBarArray.sort();
		}
	},

	
	categoryClick: function() {
		this.category = event.target.innerHTML;
		viewModel.resetSideBar();
		viewModel.clearMarkers();
		viewModel.addSideBarInfo();
		viewModel.addMarkers();
	},

	//0 = black, 1 = red for sideBar text
	//highlightText: ko.observable(0),


	//when you click the marker on the map	
	highlightToggle: function() {
		var list = document.getElementsByClassName("sideBarElems");
var myKey = Object.valueOf(mapMarkers[category]);////////// TODO: loop through categories - eh, probably wont work
		for (var i = 0; i < viewModel.markers.length; i++) {
			console.log(myKey);
			var appearance = list[i].id;
			//var contentString = "<div><h3>" + this.id + "</h3><a>" + mapMarkers[this.category][this.id][fb] + "</a></div>"

			if (list[i].innerHTML == this.id){ //if the marker id matches the sidebar name
				list[i].setAttribute("id", "highlight");//make search term red
								//make info bubble pop up
				var infowindow = new google.maps.InfoWindow({
					content: this.id,
					map: this.map
					})
				infowindow.open(map, this);

				if (appearance == "highlight") {
					list[i].setAttribute("id", "null");
					infowindow.close();

				}else if (appearance == "highlight") {
					list[i].setAttribute("id", "");
				}
			}
		}
	},

	//when you click the search term in the sidebar
	highlightMarker: function() {
		for (var i = 0; i < viewModel.markers.length; i++) {
			if (viewModel.markers[i].id == this) {
				var marker = viewModel.markers[i];
				marker.icon = 'http://maps.google.com/mapfiles/ms/icons/red-dot.png';
				marker.map.panTo(marker.getPosition());
				marker.setMap(marker.map);
				//TODO: make that marker layered on top
				//TODO: after clicking a second marker, make the first go back to orig icon
			}
		}
	},

	resetSideBar: function() {
		this.sideBarArray([]);
	},

	clearMarkers: function() {
  		for (var i = 0; i < viewModel.markers.length; i++) {
    		viewModel.markers[i].setMap(null);
  		}
  		viewModel.markers = [];
		},


	clearSearch: function() {
		viewModel.clearMarkers();
		viewModel.resetSideBar();
	},

	searchArray: function() {

	}


};
viewModel.init();
ko.applyBindings(viewModel);





